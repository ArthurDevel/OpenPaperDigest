# Plan: Remove Users Table and Use Supabase Auth Directly

## High Level Goal

Remove the separate `public.users` table and rely entirely on Supabase Auth (`auth.users`) for user identity. This eliminates the need to sync users between auth and application tables, fixing the "User not found" error when authenticated users try to add papers to their list.

The `user_id` columns in `user_lists` and `user_requests` will continue to store the Supabase Auth user UUID, but without foreign key constraints (since you cannot FK to `auth.users` from the `public` schema).

---

## File Tree

```
web/
  src/
    app/
      api/
        users/
          me/
            list/
              [uuid]/
                route.ts            [MODIFIED] Remove dead "User not found" error handling
            requests/
              [arxivId]/
                route.ts            [MODIFIED] Remove dead "User not found" error handling
    lib/
      types/
        database.types.ts           [AUTO-SYNCED] Will update automatically after Supabase UI changes
    services/
      users.service.ts              [MODIFIED] Remove user sync/lookup functions, remove user existence checks
      users.service.test.ts         [MODIFIED] Update tests to reflect removed functions
    types/
      user.ts                       [MODIFIED] Remove User interface, SyncUserPayload, userEmail from AdminRequestItem
```

---

## Per-File Methods and Types

### database.types.ts (AUTO-SYNCED)

No manual changes needed. After dropping the `users` table in Supabase UI, run:
```bash
npx supabase gen types typescript --project-id <project-id> > src/lib/types/database.types.ts
```

---

### user.ts (MODIFIED)

#### Types to Remove

```typescript
// REMOVE - only used by getUserByAuthProviderId which we're removing
User {
  id: string
  email: string
  createdAt: Date
}

// REMOVE - was used for syncing users from auth
SyncUserPayload {
  id: string
  email: string
}
```

#### Types to Modify

```typescript
// MODIFY - remove userEmail field
AdminRequestItem {
  id: number
  userId: string
  // userEmail: string  <-- REMOVE
  arxivId: string
  title: string | null
  authors: string | null
  createdAt: Date
  isProcessed: boolean
  processedSlug: string | null
}
```

---

### users.service.ts (MODIFIED)

#### Functions to Remove

| Function | Lines | Reason |
|----------|-------|--------|
| `syncNewUser` | 36-67 | No longer needed - users exist in auth.users |
| `getUserByAuthProviderId` | 74-96 | No longer needed - use supabase.auth.getUser() instead |

#### Functions to Modify

| Function | Lines | Change |
|----------|-------|--------|
| `addToList` | 114-127 | Remove user existence check |
| `addRequest` | 357-370 | Remove user existence check |
| `getAllRequests` | 505-551 | Remove users table join, remove userEmail from response |

#### Code Change for getAllRequests

```typescript
// Current query (lines 508-523):
.select(`
  id, user_id, arxiv_id, title, authors, created_at, is_processed, processed_slug,
  users (email)
`)

// Should become:
.select(`
  id, user_id, arxiv_id, title, authors, created_at, is_processed, processed_slug
`)
```

---

### route.ts (list/[uuid]) (MODIFIED)

#### Changes
- Remove dead error handling for "User not found" (lines 88-96)
- Only keep "Paper not found" error handling

---

### route.ts (requests/[arxivId]) (MODIFIED)

#### Changes
- Remove dead error handling for "User not found" (lines 98-101)

---

### users.service.test.ts (MODIFIED)

#### Changes
- Remove tests for `syncNewUser`
- Remove tests for `getUserByAuthProviderId`
- Update tests for `addToList` and `addRequest` to not mock user lookup
- Update tests for `getAllRequests` to not include userEmail

---

## Important Technical Notes

### Why we cannot use FK to auth.users

Supabase's `auth.users` table lives in the protected `auth` schema. PostgreSQL does not allow creating foreign key constraints from `public` schema tables to `auth` schema tables. This is a security feature.

The `user_id` columns will still store valid Supabase Auth UUIDs, but referential integrity is enforced at the application level (via `supabase.auth.getUser()` checks in API routes) rather than at the database level.

### RLS Policy Requirements

With the anon key (not service role), Row Level Security applies. Verify these policies exist on `user_lists` and `user_requests`:

```sql
-- Check existing policies
SELECT * FROM pg_policies WHERE tablename IN ('user_lists', 'user_requests');
```

If missing, create them:

```sql
CREATE POLICY "Users can manage their own list items"
ON user_lists FOR ALL USING (auth.uid()::text = user_id);

CREATE POLICY "Users can manage their own requests"
ON user_requests FOR ALL USING (auth.uid()::text = user_id);
```

### Admin Email Visibility

After this migration, admin users will no longer see which email made a request in the `/api/admin/papers/requests` endpoint. If needed, admin can look up user details via Supabase dashboard using the `userId` field.

---

## Phases

### Phase 1: Database Changes (Supabase UI) ✅

1. Verify RLS policies exist on `user_lists` and `user_requests`
2. Drop FK constraint `fk_user_lists_user` from `user_lists` table
3. Drop FK constraint `fk_user_requests_user` from `user_requests` table
4. Drop the `users` table
5. Sync types: `npx supabase gen types typescript`

### Phase 2: Update Type Definitions ✅

1. Remove `User` and `SyncUserPayload` from `types/user.ts`
2. Remove `userEmail` from `AdminRequestItem` in `types/user.ts`

### Phase 3: Update Service Layer ✅

1. Remove `syncNewUser` function from `users.service.ts`
2. Remove `getUserByAuthProviderId` function from `users.service.ts`
3. Remove user existence check from `addToList` (lines 114-127)
4. Remove user existence check from `addRequest` (lines 357-370)
5. Update `getAllRequests` to remove users join and userEmail mapping

### Phase 4: Update API Routes ✅

1. Remove dead "User not found" error handling from `web/src/app/api/users/me/list/[uuid]/route.ts` (lines 88-96)
2. Remove dead "User not found" error handling from `web/src/app/api/users/me/requests/[arxivId]/route.ts` (lines 98-101)

### Phase 5: Update Tests

1. Remove tests for deleted functions in `users.service.test.ts`
2. Update remaining tests to reflect new behavior

### Phase 6: Verification

1. Test adding paper to list as authenticated user
2. Test adding paper request as authenticated user
3. Test admin requests endpoint `/api/admin/papers/requests`
4. Verify no TypeScript errors
5. Run all tests

---

## Success Criteria

- [ ] RLS policies verified on `user_lists` and `user_requests`
- [ ] Authenticated users can add papers to their list without "User not found" error
- [ ] Authenticated users can create paper requests without "User not found" error
- [ ] Admin endpoint `/api/admin/papers/requests` returns requests (without userEmail)
- [ ] No TypeScript compilation errors
- [ ] All existing tests pass (with updated expectations)
- [ ] `users` table no longer exists in database
- [ ] No references to `users` table in codebase
