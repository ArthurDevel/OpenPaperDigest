# Next.js + TypeScript Migration Plan

## High Level Goal

Refactor the Paper Summarizer codebase to fully utilize Next.js with TypeScript by:

1. Migrating all FastAPI endpoints to Next.js API routes
2. Using Prisma ORM for TypeScript database access (existing schema unchanged)
3. Separating Airflow + Python processing into an independent worker service
4. Eliminating the reverse proxy pattern (direct API routes instead)
5. Consolidating the web application into a single Next.js deployment

The Python worker service (Airflow + paperprocessor) continues using SQLAlchemy. Database schema remains unchanged - Prisma uses introspection only.

---

## File Tree

### New Structure

```
/
├── web/                                          # Next.js Application
│   ├── src/
│   │   ├── app/                                  # App Router
│   │   │   ├── layout.tsx                        (MODIFIED - remove proxy setup)
│   │   │   ├── page.tsx                          (KEEP)
│   │   │   ├── (pages)/                          # Route group for pages
│   │   │   │   ├── paper/[slug]/page.tsx         (KEEP)
│   │   │   │   ├── papers/page.tsx               (KEEP)
│   │   │   │   ├── scrollingpapers/page.tsx      (KEEP)
│   │   │   │   ├── sharedpaper/[slug]/page.tsx   (KEEP)
│   │   │   │   ├── checkpaper/[arxivId]/page.tsx (KEEP)
│   │   │   │   ├── user/
│   │   │   │   │   ├── list/page.tsx             (KEEP)
│   │   │   │   │   └── requests/page.tsx         (KEEP)
│   │   │   │   ├── management/
│   │   │   │   │   ├── page.tsx                  (KEEP)
│   │   │   │   │   └── papers-overview/page.tsx  (KEEP)
│   │   │   │   ├── login/page.tsx                (KEEP)
│   │   │   │   ├── about/page.tsx                (KEEP)
│   │   │   │   ├── donate/page.tsx               (KEEP)
│   │   │   │   ├── roadmap/page.tsx              (KEEP)
│   │   │   │   ├── latextest/page.tsx            (KEEP)
│   │   │   │   └── auth/callback/page.tsx        (KEEP)
│   │   │   │
│   │   │   └── api/                              # API Routes (replaces FastAPI)
│   │   │       ├── auth/[...betterauth]/route.ts (KEEP)
│   │   │       ├── health/route.ts               (KEEP - also aliased at /health)
│   │   │       ├── papers/
│   │   │       │   ├── minimal/route.ts          (NEW - GET minimal list)
│   │   │       │   ├── count_since/route.ts      (NEW - GET count since timestamp)
│   │   │       │   ├── check_arxiv/[id]/route.ts (NEW - GET check arxiv existence)
│   │   │       │   ├── enqueue_arxiv/route.ts    (NEW - POST enqueue arxiv paper)
│   │   │       │   ├── thumbnails/[uuid]/route.ts(NEW - GET thumbnail image)
│   │   │       │   ├── slug/[slug]/route.ts      (NEW - GET resolve slug)
│   │   │       │   ├── [uuid]/
│   │   │       │   │   ├── route.ts              (NEW - GET full paper JSON)
│   │   │       │   │   ├── summary/route.ts      (NEW - GET paper summary)
│   │   │       │   │   ├── markdown/route.ts     (NEW - GET paper markdown)
│   │   │       │   │   └── slug/route.ts         (NEW - GET/POST slug for paper)
│   │   │       ├── users/
│   │   │       │   ├── sync/route.ts             (NEW - POST sync user)
│   │   │       │   └── me/
│   │   │       │       ├── list/
│   │   │       │       │   ├── route.ts          (NEW - GET list)
│   │   │       │       │   └── [uuid]/route.ts   (NEW - GET check, POST add, DELETE remove)
│   │   │       │       ├── requests/
│   │   │       │       │   ├── route.ts          (NEW - GET list requests)
│   │   │       │       │   └── [arxivId]/route.ts(NEW - GET/POST/DELETE request)
│   │   │       │       └── papers/[uuid]/
│   │   │       │           └── processing_metrics/route.ts (NEW)
│   │   │       ├── arxiv-metadata/[id]/route.ts  (NEW - GET arxiv metadata)
│   │   │       └── admin/
│   │   │           ├── papers/
│   │   │           │   ├── route.ts              (NEW - GET list papers)
│   │   │           │   ├── cumulative_daily/route.ts (NEW - GET daily stats)
│   │   │           │   ├── import_json/route.ts  (NEW - POST import)
│   │   │           │   └── [uuid]/
│   │   │           │       ├── restart/route.ts  (NEW - POST restart)
│   │   │           │       ├── route.ts          (NEW - DELETE paper)
│   │   │           │       └── processing_metrics/route.ts (NEW)
│   │   │           └── requested_papers/
│   │   │               ├── route.ts              (NEW - GET list)
│   │   │               └── [id]/
│   │   │                   ├── start_processing/route.ts (NEW - POST)
│   │   │                   └── route.ts          (NEW - DELETE)
│   │   │
│   │   ├── components/                           (KEEP - from frontend/components)
│   │   │   ├── PaperCard.tsx
│   │   │   ├── NavBar.tsx
│   │   │   ├── Footer.tsx
│   │   │   └── ...
│   │   │
│   │   ├── lib/                                  # Shared utilities
│   │   │   ├── db.ts                             (NEW - Prisma client instance)
│   │   │   ├── arxiv.ts                          (NEW - arXiv API client)
│   │   │   ├── auth.ts                           (MODIFIED - from authentication/)
│   │   │   ├── env.ts                            (NEW - Zod environment validation)
│   │   │   └── admin-auth.ts                     (NEW - HTTP Basic auth helper)
│   │   │
│   │   ├── services/                             # Business logic layer
│   │   │   ├── papers.service.ts                 (NEW - Paper CRUD operations)
│   │   │   ├── users.service.ts                  (NEW - User operations)
│   │   │   └── slugs.service.ts                  (NEW - Slug generation/resolution)
│   │   │
│   │   ├── types/                                # TypeScript interfaces
│   │   │   ├── paper.ts                          (NEW - Paper types)
│   │   │   ├── user.ts                           (NEW - User types)
│   │   │   └── api.ts                            (NEW - API request/response types)
│   │   │
│   │   └── hooks/                                (KEEP - from frontend/hooks)
│   │       └── ...
│   │
│   ├── prisma/
│   │   └── schema.prisma                         (NEW - Generated via `prisma db pull`)
│   │
│   ├── public/                                   (KEEP - from frontend/public)
│   ├── package.json                              (MODIFIED - add Prisma, remove proxy deps)
│   ├── tsconfig.json                             (MODIFIED - enable strict mode)
│   ├── tailwind.config.ts                        (KEEP)
│   ├── next.config.js                            (MODIFIED - remove rewrites, add /health rewrite)
│   └── Dockerfile                                (NEW - standalone Next.js build)
│
├── worker/                                       # Python Worker Service
│   ├── dags/                                     (MOVED from airflow/dags/)
│   │   ├── arxiv_discovery_dag.py
│   │   ├── paper_processing_worker_dag.py
│   │   ├── daily_alphaxiv_papers_dag.py
│   │   ├── daily_deepmind_research_papers_dag.py
│   │   ├── daily_google_research_papers_dag.py
│   │   ├── daily_microsoft_research_papers_dag.py
│   │   ├── daily_nvidia_research_papers_dag.py
│   │   ├── daily_huggingface_papers_dag.py
│   │   ├── daily_huggingface_trending_papers_dag.py
│   │   ├── backfill_arxiv_urls_dag.py
│   │   ├── daily_paper_status_history_dag.py
│   │   ├── regenerate_missing_thumbnails_dag.py
│   │   ├── reset_stuck_papers_dag.py
│   │   ├── cleanup_page_images_dag.py
│   │   ├── compress_oversized_thumbnails_dag.py
│   │   ├── backfill_final_markdown_dag.py
│   │   └── hello_world_dag.py
│   │
│   ├── paperprocessor/                           (MOVED from paperprocessor/)
│   │   ├── client.py
│   │   ├── models.py
│   │   └── internals/
│   │       ├── pdf_to_image.py
│   │       ├── mistral_ocr.py
│   │       ├── section_rewriter.py
│   │       ├── summary_generator.py
│   │       ├── structure_extractor.py
│   │       ├── metadata_extractor.py
│   │       └── header_formatter.py
│   │
│   ├── shared/                                   (MOVED from shared/)
│   │   ├── config.py
│   │   ├── db.py
│   │   ├── utils.py
│   │   ├── pdf_utils.py
│   │   ├── arxiv/
│   │   │   ├── client.py
│   │   │   └── models.py
│   │   ├── openrouter/
│   │   │   ├── client.py
│   │   │   └── models.py
│   │   ├── qdrant/
│   │   │   ├── client.py
│   │   │   └── models.py
│   │   └── voyageai/
│   │       ├── client.py
│   │       └── models.py
│   │
│   ├── papers/                                   (MOVED from papers/)
│   │   ├── client.py
│   │   ├── models.py
│   │   └── db/
│   │       └── models.py
│   │
│   ├── users/                                    (MOVED from users/)
│   │   ├── client.py
│   │   └── models.py
│   │
│   ├── search/                                   (MOVED from search/)
│   │   ├── client.py
│   │   └── internals/
│   │       └── prompt_loader.py
│   │
│   ├── requirements.txt                          (MODIFIED - remove FastAPI deps)
│   ├── airflow.cfg                               (KEEP)
│   ├── entrypoint.sh                             (MODIFIED - only start Airflow)
│   └── Dockerfile                                (NEW - Python worker only)
│
├── migrations/                                   (KEEP - Alembic migrations, infrastructure)
│   ├── versions/
│   └── alembic.ini
│
├── docker-compose.yml                            (MODIFIED - separate web and worker services)
├── .env.example                                  (MODIFIED - updated variable names)
├── .env                                          (MODIFIED)
├── .gitignore                                    (KEEP)
│
└── data/                                         (KEEP - persistent volumes)
    ├── mysql/
    ├── mysql_auth/
    ├── qdrant/
    ├── airflow_postgres/
    ├── umami_postgres/
    └── paperjsons/                               (KEEP - admin import writes JSON here)
```

### Files to DELETE (after migration)

```
/api/                           # Entire FastAPI backend (replaced by Next.js API routes)
/frontend/                      # Moved to /web
/airflow/                       # Moved to /worker/dags
/paperprocessor/                # Moved to /worker/paperprocessor
/shared/                        # Moved to /worker/shared
/papers/                        # Moved to /worker/papers
/users/                         # Moved to /worker/users
/search/                        # Moved to /worker/search
```

**Note:** `/migrations/` stays at root level - it's infrastructure that manages the database schema used by both web and worker.

**Also delete:**
- `frontend/app/arxiv-search/` - Search page removed (not needed)
- `frontend/app/layouttests/` - Test page removed
- `frontend/services/api.ts` search-related exports - Remove `searchPapers` function and related types

### Deprecated Endpoints (NOT migrated)

The following FastAPI endpoints will not be migrated:

- `POST /papers/process` - Direct PDF upload for background processing
- `GET /papers/process/{job_id}` - Poll job status
- `POST /search/query` - Vector search with filters
- `GET /search/paper/{paper_uuid}/similar` - Similar papers by vector

The first two were exported from `api.ts` but never imported anywhere. The search endpoints are being removed entirely.

---

## Per-File Methods and Types/DTOs

### web/prisma/schema.prisma (NEW)

#### Models

```prisma
model Paper {
  id                      BigInt    @id @default(autoincrement())
  paperUuid               String    @unique @map("paper_uuid") @db.VarChar(36)
  arxivId                 String?   @unique @map("arxiv_id") @db.VarChar(64)
  arxivVersion            String?   @map("arxiv_version") @db.VarChar(10)
  arxivUrl                String?   @map("arxiv_url") @db.VarChar(255)
  title                   String?   @db.VarChar(512)
  authors                 String?   @db.Text
  status                  String    @default("not_started") @db.VarChar(20)
  errorMessage            String?   @map("error_message") @db.Text
  initiatedByUserId       String?   @map("initiated_by_user_id") @db.VarChar(128)
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  startedAt               DateTime? @map("started_at")
  finishedAt              DateTime? @map("finished_at")
  numPages                Int?      @map("num_pages")
  processingTimeSeconds   Float?    @map("processing_time_seconds")
  totalCost               Float?    @map("total_cost")
  avgCostPerPage          Float?    @map("avg_cost_per_page")
  thumbnailDataUrl        String?   @map("thumbnail_data_url") @db.MediumText
  externalPopularitySignals Json?   @map("external_popularity_signals")
  processedContent        String?   @map("processed_content") @db.LongText
  contentHash             String?   @unique @map("content_hash") @db.VarChar(64)
  pdfUrl                  String?   @map("pdf_url") @db.VarChar(512)

  slugs                   PaperSlug[]
  userLists               UserList[]

  @@map("papers")
  @@index([initiatedByUserId])
  @@index([contentHash])
}

model PaperSlug {
  id        BigInt    @id @default(autoincrement())
  slug      String    @unique @db.VarChar(255)
  paperUuid String?   @map("paper_uuid") @db.VarChar(36)
  createdAt DateTime  @default(now()) @map("created_at")
  tombstone Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  paper     Paper?    @relation(fields: [paperUuid], references: [paperUuid])

  @@map("paper_slugs")
}

model PaperStatusHistory {
  id              BigInt   @id @default(autoincrement())
  date            DateTime @unique @db.Date
  totalCount      Int      @map("total_count")
  failedCount     Int      @map("failed_count")
  processedCount  Int      @map("processed_count")
  notStartedCount Int      @map("not_started_count")
  processingCount Int      @map("processing_count")
  snapshotAt      DateTime @default(now()) @map("snapshot_at")

  @@map("paper_status_history")
  @@index([date])
}

model User {
  id        String     @id @db.VarChar(128)
  email     String     @db.VarChar(255)
  createdAt DateTime   @default(now()) @map("created_at")

  lists     UserList[]
  requests  UserRequest[]

  @@map("users")
}

model UserList {
  id        BigInt   @id @default(autoincrement())
  userId    String   @map("user_id") @db.VarChar(128)
  paperId   BigInt   @map("paper_id")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  paper     Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)

  @@unique([userId, paperId])
  @@map("user_lists")
  @@index([userId])
  @@index([paperId])
}

model UserRequest {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id") @db.VarChar(128)
  arxivId       String   @map("arxiv_id") @db.VarChar(64)
  title         String?  @db.VarChar(512)
  authors       String?  @db.VarChar(2048)
  createdAt     DateTime @default(now()) @map("created_at")
  isProcessed   Boolean  @default(false) @map("is_processed")
  processedSlug String?  @map("processed_slug") @db.VarChar(255)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, arxivId])
  @@map("user_requests")
  @@index([userId])
  @@index([arxivId])
  @@index([isProcessed])
}
```

---

### web/src/types/paper.ts (NEW)

#### Types

```typescript
PaperStatus = "not_started" | "processing" | "completed" | "failed"

// Note: Internal `id` (BigInt in DB) is rarely exposed to API.
// Use `paperUuid` (string) for all external identification.
Paper {
  paperUuid: string
  arxivId: string | null
  arxivVersion: string | null
  arxivUrl: string | null
  title: string | null
  authors: string | null
  status: PaperStatus
  errorMessage: string | null
  initiatedByUserId: string | null
  createdAt: Date
  updatedAt: Date
  startedAt: Date | null
  finishedAt: Date | null
  numPages: number | null
  processingTimeSeconds: number | null
  totalCost: number | null
  avgCostPerPage: number | null
  thumbnailDataUrl: string | null
  externalPopularitySignals: Record<string, unknown> | null
  processedContent: string | null
  contentHash: string | null
  pdfUrl: string | null
}

MinimalPaper {
  paperUuid: string
  title: string | null
  authors: string | null
  thumbnailDataUrl: string | null
  slug: string | null
}

PaperSummary {
  paperId: string
  title: string | null
  authors: string | null
  arxivUrl: string | null
  fiveMinuteSummary: string | null
  pageCount: number
  thumbnailUrl: string | null
}

PaginatedMinimalPapers {
  items: MinimalPaper[]
  total: number
  page: number
  limit: number
  hasMore: boolean
}

JobDbStatus {
  paperUuid: string
  status: PaperStatus
  errorMessage: string | null
  createdAt: Date
  updatedAt: Date
  startedAt: Date | null
  finishedAt: Date | null
  arxivId: string | null
  arxivVersion: string | null
  arxivUrl: string | null
  title: string | null
  authors: string | null
  numPages: number | null
  thumbnailDataUrl: string | null
  processingTimeSeconds: number | null
  totalCost: number | null
  avgCostPerPage: number | null
}

EnqueueArxivRequest {
  url: string
}

EnqueueArxivResponse {
  jobDbId: number
  paperUuid: string
  status: string
}

CheckArxivResponse {
  exists: boolean
  viewerUrl: string | null
}

ResolveSlugResponse {
  paperUuid: string | null
  slug: string
  tombstone: boolean
}
```

---

### web/src/types/user.ts (NEW)

#### Types

```typescript
User {
  id: string
  email: string
  createdAt: Date
}

SyncUserPayload {
  id: string
  email: string
}

UserListItem {
  paperUuid: string
  title: string | null
  authors: string | null
  thumbnailDataUrl: string | null
  slug: string | null
  createdAt: Date
}

UserRequestItem {
  arxivId: string
  title: string | null
  authors: string | null
  createdAt: Date
  isProcessed: boolean
  processedSlug: string | null
}

ExistsResponse {
  exists: boolean
}

CreatedResponse {
  created: boolean
}

DeletedResponse {
  deleted: boolean
}
```

---

### web/src/lib/db.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `prisma` | - | `PrismaClient` | Singleton Prisma client instance with connection pooling |

---

### web/src/lib/env.ts (NEW)

Uses [Zod](https://zod.dev/) library to validate environment variables at startup.

#### Schema

```typescript
import { z } from 'zod'

const envSchema = z.object({
  // Database
  DATABASE_URL: z.string().url(),

  // Admin
  ADMIN_BASIC_PASSWORD: z.string().min(1),

  // Optional
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
})

export const env = envSchema.parse(process.env)
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `env` | - | `z.infer<typeof envSchema>` | Validated environment variables object |

---

### web/src/lib/arxiv.ts (NEW)

#### Types

```typescript
NormalizedArxivId {
  arxivId: string
  version: string | null
}

ArxivMetadata {
  arxivId: string
  title: string
  authors: string[]
  abstract: string
  publishedAt: Date
  categories: string[]
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `normalizeId` | `urlOrId: string` | `Promise<NormalizedArxivId>` | Parse arXiv URL or ID into normalized form |
| `fetchMetadata` | `arxivId: string` | `Promise<ArxivMetadata>` | Fetch paper metadata from arXiv API |

---

### web/src/lib/admin-auth.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `requireAdmin` | `request: NextRequest` | `Promise<void>` | Validate HTTP Basic auth for admin endpoints. Throws 401 Response if invalid |

---

### web/src/services/papers.service.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `listMinimalPapers` | `page?: number, limit?: number` | `Promise<PaginatedMinimalPapers>` | Get paginated list of papers with minimal fields |
| `getPaperByUuid` | `uuid: string` | `Promise<Paper \| null>` | Get full paper record by UUID |
| `getPaperBySlug` | `slug: string` | `Promise<Paper \| null>` | Get paper by resolving slug first |
| `getPaperSummary` | `uuid: string` | `Promise<PaperSummary>` | Get lightweight paper summary |
| `getPaperMarkdown` | `uuid: string` | `Promise<string>` | Get raw markdown content |
| `getPaperJson` | `uuid: string` | `Promise<Record<string, unknown>>` | Get full processed content JSON |
| `countPapersSince` | `since: Date` | `Promise<number>` | Count completed papers since timestamp |
| `checkArxivExists` | `arxivIdOrUrl: string` | `Promise<CheckArxivResponse>` | Check if arXiv paper exists and is processed |
| `enqueueArxiv` | `url: string` | `Promise<EnqueueArxivResponse>` | Create paper record for arXiv processing |
| `getThumbnail` | `uuid: string` | `Promise<{ data: Buffer, mediaType: string }>` | Get thumbnail image bytes |
| `importPaperJson` | `paper: Record<string, unknown>` | `Promise<JobDbStatus>` | Import paper JSON and write to data/paperjsons/ |

---

### web/src/services/slugs.service.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `resolveSlug` | `slug: string` | `Promise<ResolveSlugResponse>` | Resolve slug to paper UUID |
| `getSlugForPaper` | `paperUuid: string` | `Promise<ResolveSlugResponse>` | Get latest non-tombstone slug for paper |
| `createSlug` | `paperUuid: string` | `Promise<ResolveSlugResponse>` | Create slug for paper (idempotent) |
| `buildPaperSlug` | `title: string \| null, authors: string \| null` | `string` | Generate URL-safe slug from title and authors |

---

### web/src/services/users.service.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `syncNewUser` | `payload: SyncUserPayload` | `Promise<{ created: boolean }>` | Create user record from BetterAuth hook |
| `getUserByAuthProviderId` | `authProviderId: string` | `Promise<User \| null>` | Get user by auth provider ID |
| `addToList` | `authProviderId: string, paperUuid: string` | `Promise<CreatedResponse>` | Add paper to user's list |
| `removeFromList` | `authProviderId: string, paperUuid: string` | `Promise<DeletedResponse>` | Remove paper from user's list |
| `getList` | `authProviderId: string` | `Promise<UserListItem[]>` | Get all papers in user's list |
| `isInList` | `authProviderId: string, paperUuid: string` | `Promise<ExistsResponse>` | Check if paper is in user's list |
| `addRequest` | `authProviderId: string, arxivId: string` | `Promise<CreatedResponse>` | Add paper request |
| `removeRequest` | `authProviderId: string, arxivId: string` | `Promise<DeletedResponse>` | Remove paper request |
| `listRequests` | `authProviderId: string` | `Promise<UserRequestItem[]>` | Get all user's requests |
| `doesRequestExist` | `authProviderId: string, arxivId: string` | `Promise<ExistsResponse>` | Check if request exists |

---

### web/src/app/api/papers/[uuid]/route.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `GET` | `request: NextRequest, { params }` | `NextResponse<Record<string, unknown>>` | Get full paper JSON by UUID |

---

### web/src/app/api/users/me/list/route.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `GET` | `request: NextRequest` | `NextResponse<UserListItem[]>` | Get current user's paper list |

---

### web/src/app/api/users/me/list/[uuid]/route.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `GET` | `request: NextRequest, { params }` | `NextResponse<ExistsResponse>` | Check if paper is in user's list |
| `POST` | `request: NextRequest, { params }` | `NextResponse<CreatedResponse>` | Add paper to user's list |
| `DELETE` | `request: NextRequest, { params }` | `NextResponse<DeletedResponse>` | Remove paper from user's list |

---

## Important Technical Notes

### 1. Database Access Pattern

Both the Next.js web app and Python worker need database access:
- **Web app**: Uses Prisma as a **TypeScript database client** (type-safe queries)
- **Worker**: Uses SQLAlchemy (Python) + Alembic migrations

Both connect to the same MySQL instance. **The database schema is unchanged.**

**What is Prisma?** Prisma is simply a TypeScript ORM that lets Next.js API routes query the database with type safety. It replaces SQLAlchemy for the web app only.

**Prisma setup (introspection-only mode):**
1. Run `prisma db pull` once to generate `schema.prisma` from the existing database
2. Run `prisma generate` to create the TypeScript client
3. **Never run `prisma migrate`** - schema is managed by Alembic
4. If Alembic changes the schema, re-run `prisma db pull` to sync

**BetterAuth tables:** BetterAuth manages its own tables (`user`, `session`, `account`, etc.) via its internal migrations. These are separate from application tables and handled automatically.

### 2. Authentication Flow

The current reverse proxy injects `X-Auth-Provider-Id` header for authenticated endpoints. With direct API routes:

```typescript
// In each protected API route:
import { auth } from '@/lib/auth'

export async function GET(request: NextRequest) {
  const session = await auth.api.getSession({ headers: request.headers })
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  const userId = session.user.id
  // ... continue with userId
}
```

**BetterAuth Hook Update:** The user creation hook in `authentication/server_auth.ts` currently calls the Python backend directly at `http://127.0.0.1:${CONTAINERPORT_API}/users/sync`. After migration, update this to call the Next.js API route at `/api/users/sync` (or use the service directly since it's server-side code).

### 3. API Response Conventions

All API responses use **camelCase** (TypeScript conventions), not snake_case. This is a breaking change from the Python API. Frontend `api.ts` service functions must be updated to expect camelCase keys.

Example: `paper_uuid` → `paperUuid`, `viewer_url` → `viewerUrl`

### 4. Admin Authentication

Admin endpoints use HTTP Basic authentication:

```typescript
// web/src/lib/admin-auth.ts
export async function requireAdmin(request: NextRequest): Promise<void> {
  const authHeader = request.headers.get('authorization')
  if (!authHeader?.startsWith('Basic ')) {
    throw new Response('Unauthorized', {
      status: 401,
      headers: { 'WWW-Authenticate': 'Basic realm="Management"' }
    })
  }

  const credentials = Buffer.from(authHeader.slice(6), 'base64').toString()
  const [username, password] = credentials.split(':')

  const expectedUser = 'admin'
  const expectedPass = process.env.ADMIN_BASIC_PASSWORD || ''

  // Use timing-safe comparison
  if (username !== expectedUser || password !== expectedPass) {
    throw new Response('Unauthorized', { status: 401 })
  }
  // Returns void on success
}
```

### 5. Thumbnail Serving

Thumbnails are stored as base64 data URLs in the database. The API route decodes and serves them:

```typescript
// web/src/app/api/papers/thumbnails/[uuid]/route.ts
export async function GET(request: NextRequest, { params }) {
  const { data, mediaType } = await papersService.getThumbnail(params.uuid)

  return new Response(data, {
    headers: {
      'Content-Type': mediaType,
      'Cache-Control': 'public, max-age=31536000, immutable'
    }
  })
}
```

### 6. Admin Import - File System Writes

The admin import endpoint writes JSON to `data/paperjsons/{uuid}.json`:

```typescript
// In papers.service.ts importPaperJson()
const basePath = path.join(process.cwd(), 'data', 'paperjsons')
await fs.mkdir(basePath, { recursive: true })
await fs.writeFile(path.join(basePath, `${paperUuid}.json`), JSON.stringify(paper))
```

This directory must be mounted as a volume in Docker for persistence.

### 7. Health Check Route

To maintain backward compatibility with `/health` (without `/api` prefix):

```javascript
// next.config.js
module.exports = {
  async rewrites() {
    return [
      {
        source: '/health',
        destination: '/api/health',
      },
    ]
  },
}
```

### 8. Environment Variables

Update `.env` structure for the split services:

```bash
# Shared (main application database)
MYSQL_HOST=mysql
MYSQL_USER=workflow_user
MYSQL_PASSWORD=***
MYSQL_DATABASE=workflow_db
MYSQL_PORT=3306

# BetterAuth database (separate MySQL instance)
AUTH_MYSQL_HOST=mysql_auth
AUTH_MYSQL_USER=auth_user
AUTH_MYSQL_PASSWORD=***
AUTH_MYSQL_DATABASE=auth_db
AUTH_MYSQL_PORT=3306

# Web-specific
DATABASE_URL="mysql://workflow_user:***@mysql:3306/workflow_db"
ADMIN_BASIC_PASSWORD=***

# Worker-specific (unchanged)
MISTRAL_API_KEY=***
QDRANT_HOST=qdrant
QDRANT_PORT=6333
VOYAGE_API_KEY=***
OPENROUTER_API_KEY=***
```

---

## Phases

### Phase 1: Project Setup and Infrastructure [DONE]

- [x] Create `web/` directory structure
- [x] Move frontend files to web:
  - `frontend/app/` → `web/src/app/`
  - `frontend/components/` → `web/src/components/`
  - `frontend/hooks/` → `web/src/hooks/`
  - `frontend/services/` → `web/src/services/`
  - `frontend/types/` → `web/src/types/`
  - `frontend/utils/` → `web/src/utils/`
  - `frontend/authentication/` → `web/src/lib/` (consolidate)
  - `frontend/public/` → `web/public/`
  - `frontend/package.json`, `tsconfig.json`, etc. → `web/`
- [x] Create `schema.prisma` based on plan specification
- [x] Update `package.json` with Prisma and Zod dependencies
- [x] Enable strict TypeScript in `tsconfig.json`

### Phase 2: Shared Libraries (web/src/lib/) [DONE]

- [x] Create `db.ts` - Prisma client singleton
- [x] Create `env.ts` - Zod environment validation
- [x] Create `arxiv.ts` - arXiv API client (port from Python)
- [x] Create `admin-auth.ts` - HTTP Basic auth helper
- [x] Update `auth.ts` - consolidate BetterAuth config

### Phase 3: Type Definitions (web/src/types/) [DONE]

- [x] Create `paper.ts` - Paper-related types
- [x] Create `user.ts` - User-related types
- [x] Create `api.ts` - Shared API types

### Phase 4: Service Layer (web/src/services/) [DONE]

- [x] Create `papers.service.ts` - Paper CRUD operations
- [x] Create `slugs.service.ts` - Slug generation/resolution
- [x] Create `users.service.ts` - User operations

### Phase 5: API Routes - Papers [DONE]

- [x] Create `api/papers/minimal/route.ts` - GET minimal list
- [x] Create `api/papers/count_since/route.ts` - GET count
- [x] Create `api/papers/check_arxiv/[id]/route.ts` - GET check
- [x] Create `api/papers/enqueue_arxiv/route.ts` - POST enqueue
- [x] Create `api/papers/thumbnails/[uuid]/route.ts` - GET thumbnail
- [x] Create `api/papers/slug/[slug]/route.ts` - GET resolve
- [x] Create `api/papers/[uuid]/route.ts` - GET full paper
- [x] Create `api/papers/[uuid]/summary/route.ts` - GET summary
- [x] Create `api/papers/[uuid]/markdown/route.ts` - GET markdown
- [x] Create `api/papers/[uuid]/slug/route.ts` - GET/POST slug

### Phase 6: API Routes - Users [DONE]

- [x] Create `api/users/sync/route.ts` - POST sync
- [x] Create `api/users/me/list/route.ts` - GET list
- [x] Create `api/users/me/list/[uuid]/route.ts` - GET/POST/DELETE
- [x] Create `api/users/me/requests/route.ts` - GET list
- [x] Create `api/users/me/requests/[arxivId]/route.ts` - GET/POST/DELETE
- [x] Create `api/users/me/papers/[uuid]/processing_metrics/route.ts`

### Phase 7: API Routes - Admin [DONE]

- [x] Create `api/admin/papers/route.ts` - GET list
- [x] Create `api/admin/papers/cumulative_daily/route.ts` - GET stats
- [x] Create `api/admin/papers/import/route.ts` - POST import (with file write)
- [x] Create `api/admin/papers/[uuid]/route.ts` - DELETE
- [x] Create `api/admin/papers/[uuid]/restart/route.ts` - POST
- [x] Create `api/admin/papers/[uuid]/processing_metrics/route.ts`
- [x] Create `api/admin/requested_papers/route.ts` - GET list
- [x] Create `api/admin/requested_papers/[id]/route.ts` - DELETE
- [x] Create `api/admin/requested_papers/[id]/start_processing/route.ts` - POST

### Phase 8: API Routes - Misc [DONE]

- [x] Create `api/arxiv-metadata/[id]/route.ts` - GET metadata
- [x] Add `/health` rewrite in `next.config.js`
- [x] Remove `api/[...slug]/route.ts` - delete reverse proxy

### Phase 9: Frontend Updates [DONE]

- [x] Update API calls to use new route paths (remove `/api` prefix where needed)
- [x] Update fetch calls to not go through proxy
- [x] Remove unused `processPaper` and `getJobStatus` exports from api.ts
- [x] Delete `frontend/app/arxiv-search/` - search page removed
- [ ] Remove `searchPapers` function and related types from api.ts
- [ ] Test all pages work with new API routes

### Phase 10: Worker Service Setup [DONE]

- [x] Create `worker/` directory
- [x] Move `airflow/dags/` to `worker/dags/`
- [x] Move `paperprocessor/` to `worker/paperprocessor/`
- [x] Move `shared/` to `worker/shared/`
- [x] Move `papers/` to `worker/papers/`
- [x] Move `users/` to `worker/users/`
- [x] Move `search/` to `worker/search/`
- [x] Update all Python imports for new paths
- [x] Update `worker/Dockerfile` (Python only, no Node)
- [x] Update `worker/requirements.txt` (remove FastAPI/uvicorn)
- [x] Update `worker/entrypoint.sh` (only start Airflow)

**Note:** `/migrations/` stays at root level - it's infrastructure, not part of worker.

### Phase 11: Docker and Deployment [DONE]

- [x] Create `web/Dockerfile` (Next.js standalone build)
- [x] Update `docker-compose.yml` with separate `web` and `worker` services
- [x] Mount `data/paperjsons` volume for both services
- [x] Update `.env.example` with new variables
- [ ] Test local Docker Compose deployment
- [ ] Verify all services communicate correctly

### Phase 12: Cleanup [DONE]

- [x] Delete `/api/` directory
- [x] Delete `/frontend/` directory (now in `/web/`)
- [x] Delete `/airflow/` directory (now in `/worker/`)
- [x] Delete `/paperprocessor/` directory (now in `/worker/`)
- [x] Delete `/shared/` directory (now in `/worker/`)
- [x] Delete `/papers/` directory (now in `/worker/`)
- [x] Delete `/users/` directory (now in `/worker/`)
- [x] Delete `/search/` directory (now in `/worker/`)
- [x] Deleted old root-level Dockerfile, entrypoint.sh, requirements.txt, requirements.in

**Note:** Keep `/migrations/` at root level - it's infrastructure that manages the database schema.

---

## Success Criteria

1. **All existing functionality works** - Every API endpoint that worked before still works
2. **No Python in web service** - Next.js app is pure TypeScript/JavaScript
3. **Worker operates independently** - Airflow and processing work without web service
4. **Single database schema** - Prisma and SQLAlchemy both work with same tables
5. **Authentication unchanged** - BetterAuth magic link flow works as before
6. **Admin functions work** - HTTP Basic auth protects admin endpoints
7. **Docker deployment works** - `docker-compose up` starts both services
8. **No reverse proxy** - API routes handle requests directly
9. **TypeScript strict mode passes** - No TypeScript errors with strict enabled
10. **File system writes work** - Admin import writes to `data/paperjsons/`
11. **Health check accessible** - Both `/health` and `/api/health` work
