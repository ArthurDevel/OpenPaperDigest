# Prisma to Supabase Client Migration

## High Level Goal

Migrate the web app from using Prisma ORM with direct PostgreSQL connection to using the Supabase JavaScript client for all database operations. This unifies our data access layer with our auth provider and enables future use of Supabase features (RLS, realtime, etc.).

**Scope:** TypeScript web app only. Python worker continues using SQLAlchemy.

---

## File Tree

```
web/
├── src/
│   ├── lib/
│   │   ├── db.ts                          [DELETE] - Prisma singleton
│   │   ├── supabase/
│   │   │   ├── server.ts                  [MODIFY] - Add Database generic type
│   │   │   └── client.ts                  [NO CHANGE] - Browser client (auth only)
│   │   └── types/
│   │       └── database.types.ts          [MOVE] - Move from src/types/
│   ├── services/
│   │   ├── papers.service.ts              [MODIFY] - Prisma → Supabase queries
│   │   ├── users.service.ts               [MODIFY] - Prisma → Supabase queries
│   │   └── slugs.service.ts               [MODIFY] - Prisma → Supabase queries
│   └── types/
│       └── database.types.ts              [DELETE] - Moved to lib/types/
├── prisma/
│   └── schema.prisma                      [DELETE] - No longer needed
├── package.json                           [MODIFY] - Remove Prisma deps, update build script
└── .docs/
    └── supabase.md                        [NEW] - Type regeneration docs
```

---

## Per-File Methods and Types

### lib/types/database.types.ts (MOVE)

Generated by Supabase CLI. Contains `Database` type with all table definitions.

```ts
Database {
  public: {
    Tables: {
      papers: { Row, Insert, Update }
      paper_slugs: { Row, Insert, Update }
      users: { Row, Insert, Update }
      user_lists: { Row, Insert, Update }
      user_requests: { Row, Insert, Update }
      paper_status_history: { Row, Insert, Update }
    }
  }
}
```

---

### lib/supabase/server.ts (MODIFY)

Add `Database` generic to server client for type-safe queries.

#### Types

```ts
import type { Database } from '@/lib/types/database.types'
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createClient` | none | `Promise<SupabaseClient<Database>>` | Creates typed Supabase server client with cookie handling |

---

### services/papers.service.ts (MODIFY)

Replace all Prisma queries with Supabase client queries.

#### Client Access Pattern

Each method calls `createClient()` at the start:

```ts
import { createClient } from '@/lib/supabase/server'

export async function getPaperByUuid(uuid: string) {
  const supabase = await createClient()
  const { data, error } = await supabase.from('papers')...
}
```

#### Query Migration Summary

| Prisma Method | Supabase Equivalent |
|---------------|---------------------|
| `prisma.paper.findMany()` | `supabase.from('papers').select()` |
| `prisma.paper.findUnique({ where })` | `supabase.from('papers').select().eq('paper_uuid', uuid).maybeSingle()` |
| `prisma.paper.create({ data })` | `supabase.from('papers').insert(data).select().single()` |
| `prisma.paper.update({ where, data })` | `supabase.from('papers').update(data).eq('paper_uuid', uuid).select().single()` |
| `prisma.paper.delete({ where })` | `supabase.from('papers').delete().eq('paper_uuid', uuid)` |
| `prisma.paper.count({ where })` | `supabase.from('papers').select('*', { count: 'exact', head: true })` |

---

### services/users.service.ts (MODIFY)

Replace all Prisma queries with Supabase client queries.

#### Query Migration Summary

| Prisma Method | Supabase Equivalent |
|---------------|---------------------|
| `prisma.user.findUnique()` | `supabase.from('users').select().eq('id', id).maybeSingle()` |
| `prisma.user.create()` | `supabase.from('users').insert(data).select().single()` |
| `prisma.userList.findMany({ include })` | `supabase.from('user_lists').select('*, papers(*)')` |
| `prisma.userRequest.findMany()` | `supabase.from('user_requests').select()` |

---

### services/slugs.service.ts (MODIFY)

Replace all Prisma queries with Supabase client queries.

#### Query Migration Summary

| Prisma Method | Supabase Equivalent |
|---------------|---------------------|
| `prisma.paperSlug.findUnique({ where })` | `supabase.from('paper_slugs').select().eq('slug', slug).maybeSingle()` |
| `prisma.paperSlug.findFirst({ where, orderBy })` | `supabase.from('paper_slugs').select().match(where).order('created_at', { ascending: false }).limit(1).maybeSingle()` |
| `prisma.paperSlug.create()` | `supabase.from('paper_slugs').insert(data).select().single()` |

---

### .docs/supabase.md (NEW)

```markdown
# Supabase

## Regenerating Database Types

When database schema changes, regenerate TypeScript types:

\`\`\`bash
cd web
npx supabase gen types typescript --project-id "<PROJECT_REF>" --schema public > src/lib/types/database.types.ts
\`\`\`

Find `<PROJECT_REF>` in your Supabase dashboard URL: `https://supabase.com/dashboard/project/<PROJECT_REF>`
```

---

## Important Technical Notes

### 1. Field Name Convention

Prisma uses camelCase, Supabase uses snake_case:

| Prisma | Supabase |
|--------|----------|
| `paperUuid` | `paper_uuid` |
| `arxivId` | `arxiv_id` |
| `createdAt` | `created_at` |
| `thumbnailDataUrl` | `thumbnail_data_url` |

### 2. Date Handling

Prisma returns `Date` objects, Supabase returns ISO strings:

```ts
// Supabase returns: "2024-01-15T10:00:00Z"
// Wrap if Date object needed:
const createdAt = new Date(row.created_at)
```

### 3. Single vs MaybeSingle

- `.single()` - Throws `PGRST116` if no rows found
- `.maybeSingle()` - Returns `null` if no rows found

Use `.maybeSingle()` for lookups that might not exist (like `findUnique`).

### 4. Error Handling

```ts
// Prisma throws exceptions
const paper = await prisma.paper.findUnique({ where })

// Supabase returns { data, error }
const { data: paper, error } = await supabase
  .from('papers')
  .select()
  .eq('paper_uuid', uuid)
  .maybeSingle()

if (error) throw new Error(error.message)
```

### 5. Count Queries

```ts
const { count } = await supabase
  .from('papers')
  .select('*', { count: 'exact', head: true })
  .eq('status', 'completed')
  .gte('finished_at', since.toISOString())  // Note: toISOString()
```

### 6. Relation Queries

```ts
// Prisma include
prisma.paper.findMany({ include: { slugs: true } })

// Supabase nested select
supabase.from('papers').select('*, paper_slugs(*)')
```

### 7. No Transactions

Supabase JS client doesn't support transactions. For multi-step deletes (e.g., `deletePaper()`), we accept non-atomic behavior - orphaned records are recoverable via manual cleanup if needed.

---

## Phases

### Phase 1: Setup [COMPLETED]
- [x] Move `web/src/types/database.types.ts` → `web/src/lib/types/database.types.ts`
- [x] Create `.docs/supabase.md`
- [x] Update `web/src/lib/supabase/server.ts` with `Database` generic

### Phase 2: Migrate slugs.service.ts (~5 queries) [COMPLETED]
- [x] Replace Prisma with Supabase queries
- [x] Update field names to snake_case

### Phase 3: Migrate users.service.ts (~20 queries) [COMPLETED]
- [x] Replace Prisma with Supabase queries
- [x] Update field names to snake_case

### Phase 4: Migrate papers.service.ts (~25 queries) [COMPLETED]
- [x] Replace Prisma with Supabase queries
- [x] Update field names to snake_case
- [x] Handle relation queries

### Phase 5: Cleanup
- [ ] Delete `web/src/lib/db.ts`
- [ ] Delete `web/prisma/schema.prisma`
- [ ] Remove Prisma from `package.json` (`@prisma/client`, `prisma`)
- [ ] Remove `prisma generate` from build script

---

## Success Criteria

| Criterion | Verification |
|-----------|--------------|
| Type safety | `tsc --noEmit` passes |
| No Prisma imports | `grep -r "prisma" web/src` returns nothing |
| Build succeeds | `npm run build` completes |
| Clean deps | No Prisma in `package.json` |
