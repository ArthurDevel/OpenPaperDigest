# Supabase Auth Migration Plan

## High Level Goal

Migrate the web application's authentication system from BetterAuth to Supabase Auth while maintaining magic link (passwordless) authentication. This migration will:

1. **Eliminate the MySQL database** - BetterAuth currently uses a separate MySQL database for auth; Supabase Auth uses PostgreSQL natively
2. **Simplify architecture** - Use Supabase's built-in auth abstraction instead of managing sessions manually
3. **Consolidate email templates** - Move from 3 context-aware email templates to a single customizable Supabase dashboard template
4. **Maintain existing functionality** - User lists, paper requests, and protected API routes continue working

### Out of Scope
- Context-aware email templates (add-to-list, request-paper variants) - will use single generic magic link email
- Custom email headers for paper metadata
- Migration of existing BetterAuth users - users will need to re-register (or manual migration script if needed)

---

## Environment Variables

### Remove
```
AUTH_MYSQL_URL          # MySQL connection for BetterAuth
BETTER_AUTH_SECRET      # BetterAuth signing secret
```

### Add
```
NEXT_PUBLIC_SUPABASE_URL      # Supabase project URL
NEXT_PUBLIC_SUPABASE_ANON_KEY # Supabase anon/public key
```

---

## File Tree

```
web/src/
├── lib/
│   ├── auth.ts                           # DELETED - no longer needed
│   ├── server_auth.ts                    # DELETED - replaced by supabase utilities
│   ├── magicLink.ts                      # DELETED - context-aware templates no longer supported
│   ├── postLogin.ts                      # UNCHANGED - cookie logic remains the same
│   ├── supabase/                         # NEW DIRECTORY
│   │   ├── client.ts                     # NEW - browser client factory
│   │   ├── server.ts                     # NEW - server client factory
│   │   └── middleware.ts                 # NEW - middleware client factory
│   └── emails/                           # DELETED - entire directory (3 files)
│       ├── magic-link-email.tsx          # DELETED
│       ├── add-to-list-magic-link-email.tsx    # DELETED
│       └── request-paper-magic-link-email.tsx  # DELETED
├── services/
│   ├── auth.ts                           # MODIFIED - rewrite with Supabase browser client
│   ├── users.ts                          # MODIFIED - remove X-Auth-Provider-Id, use cookie auth
│   ├── requests.ts                       # MODIFIED - remove X-Auth-Provider-Id, use cookie auth
│   └── users.service.ts                  # MODIFIED - update user sync logic
├── app/
│   ├── api/
│   │   ├── auth/
│   │   │   ├── [...betterauth]/
│   │   │   │   └── route.tsx             # DELETED
│   │   │   └── confirm/
│   │   │       └── route.ts              # NEW - handles magic link verification
│   │   ├── users/
│   │   │   ├── sync/
│   │   │   │   └── route.ts              # DELETED - no longer needed
│   │   │   └── me/
│   │   │       ├── list/
│   │   │       │   ├── route.ts          # MODIFIED - update session retrieval
│   │   │       │   └── [uuid]/
│   │   │       │       └── route.ts      # MODIFIED - update session retrieval
│   │   │       ├── requests/
│   │   │       │   ├── route.ts          # MODIFIED - update session retrieval
│   │   │       │   └── [arxivId]/
│   │   │       │       └── route.ts      # MODIFIED - update session retrieval
│   │   │       └── papers/
│   │   │           └── [uuid]/
│   │   │               └── processing_metrics/
│   │   │                   └── route.ts  # MODIFIED - update session retrieval
│   ├── auth/
│   │   └── callback/
│   │       └── page.tsx                  # MODIFIED - remove X-Auth-Provider-Id, use Supabase session
│   ├── login/
│   │   └── page.tsx                      # MODIFIED - use Supabase signInWithOtp
│   └── user/
│       ├── layout.tsx                    # MODIFIED - update signOut call
│       ├── list/
│       │   └── page.tsx                  # MODIFIED - update useSession hook
│       └── requests/
│           └── page.tsx                  # MODIFIED - update useSession hook
├── components/
│   ├── RequireAuth.tsx                   # MODIFIED - use Supabase session hook
│   ├── NavBar.tsx                        # MODIFIED - update useSession hook
│   ├── UserSidebar.tsx                   # MODIFIED - update useSession hook
│   ├── AddToListButton.tsx               # MODIFIED - update useSession, remove magicLink import
│   ├── AddToListButtonMobile.tsx         # MODIFIED - update useSession, remove magicLink import
│   └── RequestPaperButton.tsx            # MODIFIED - update useSession, remove magicLink import
├── middleware.ts                         # MODIFIED - add Supabase session refresh (run on ALL routes)
├── types/
│   └── user.ts                           # MODIFIED - update SyncUserPayload if needed
└── package.json                          # MODIFIED - swap dependencies
```

**Total: 4 new files, 20 modified files, 8 deleted files**

---

## Per-File Methods and Types

### lib/supabase/client.ts (NEW)

#### Types

```typescript
// No custom types - uses Supabase's built-in types
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createClient` | none | `SupabaseClient` | Creates a browser-side Supabase client using `createBrowserClient` from `@supabase/ssr`. Uses singleton pattern for client reuse. |

---

### lib/supabase/server.ts (NEW)

#### Types

```typescript
// No custom types - uses Supabase's built-in types
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createClient` | none | `Promise<SupabaseClient>` | Creates a server-side Supabase client for use in Server Components and Route Handlers. Uses `cookies()` from `next/headers` for cookie operations. |

---

### lib/supabase/middleware.ts (NEW)

#### Types

```typescript
// No custom types - uses Supabase's built-in types
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createClient` | `request: NextRequest` | `{ supabase: SupabaseClient, response: NextResponse }` | Creates a Supabase client for middleware use. Handles cookie get/set on both request and response objects for proper session sync. |

---

### services/auth.ts (MODIFIED)

#### Types

```typescript
UseSessionReturn {
  user: User | null
  isLoading: boolean
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `getSupabaseClient` | none | `SupabaseClient` | Returns the browser Supabase client for use in React components |
| `useSession` | none | `UseSessionReturn` | React hook that subscribes to `onAuthStateChange` and returns current user |
| `signInWithMagicLink` | `email: string, emailRedirectTo?: string` | `Promise<{ error: AuthError \| null }>` | Sends magic link email via `supabase.auth.signInWithOtp()` |
| `signOut` | none | `Promise<{ error: AuthError \| null }>` | Signs out the current user via `supabase.auth.signOut()` |

---

### app/api/auth/confirm/route.ts (NEW)

#### Types

```typescript
// Uses EmailOtpType from @supabase/supabase-js
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `GET` | `request: NextRequest` | `NextResponse (redirect)` | Handles magic link callback. Extracts `token_hash` and `type` from URL params, calls `verifyOtp`, redirects to `/auth/callback` on success or `/auth/auth-code-error` on failure. |

---

### app/login/page.tsx (MODIFIED)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `handleSignIn` | `e: FormEvent` | `void` | Updated to call `signInWithMagicLink` instead of BetterAuth's `signIn.magicLink` |
| `handleSignOut` | none | `void` | Updated to call Supabase `signOut` |

---

### app/auth/callback/page.tsx (MODIFIED)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| Component | none | `JSX.Element` | Updated to use Supabase `useSession` hook. Removes `X-Auth-Provider-Id` header from post-login fetch calls (cookies handle auth now). |

---

### components/RequireAuth.tsx (MODIFIED)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `RequireAuth` | `{ children: ReactNode }` | `JSX.Element` | Updated to use `useSession` hook from new auth service instead of BetterAuth's `authClient.useSession()` |

---

### middleware.ts (MODIFIED)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `middleware` | `request: NextRequest` | `NextResponse` | **Critical**: Now runs Supabase session refresh on ALL routes before existing Basic Auth logic. Calls `supabase.auth.getUser()` to refresh expired tokens and sync cookies. |

---

### services/users.service.ts (MODIFIED)

#### Types

```typescript
SyncUserPayload {
  id: string      // Supabase auth.users.id (UUID format)
  email: string
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `syncNewUser` | `payload: SyncUserPayload` | `Promise<{ created: boolean }>` | Unchanged logic, but now receives Supabase UUID instead of BetterAuth ID |
| `getUserByAuthProviderId` | `authProviderId: string` | `Promise<User \| null>` | Renamed conceptually to work with Supabase user IDs |

---

### services/users.ts (MODIFIED)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| All methods | Remove `authProviderId` param | unchanged | Remove `authProviderId` parameter from all functions. Remove `buildAuthHeaders()` helper. Supabase cookies handle auth automatically via `credentials: 'include'`. |

---

### services/requests.ts (MODIFIED)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| All methods | Remove `authProviderId` param | unchanged | Remove `authProviderId` parameter from all functions. Remove `buildAuthHeaders()` helper. Supabase cookies handle auth automatically via `credentials: 'include'`. |

---

### API Route Changes (5 files)

All protected API routes under `app/api/users/me/*` follow the same pattern change:

#### Before
```typescript
const session = await auth.api.getSession({ headers: request.headers });
if (!session) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
const userId = session.user.id;
```

#### After
```typescript
const supabase = await createClient();
const { data: { user }, error } = await supabase.auth.getUser();
if (error || !user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
const userId = user.id;
```

---

### Client Components (6 files)

All components using `authClient.useSession()` follow the same pattern change:

#### Before
```typescript
import { authClient } from '@/services/auth';
const { data: session, isPending } = authClient.useSession();
const userId = session?.user?.id;
```

#### After
```typescript
import { useSession } from '@/services/auth';
const { user, isLoading } = useSession();
const userId = user?.id;
```

**Affected components:**
- `components/NavBar.tsx`
- `components/UserSidebar.tsx`
- `components/AddToListButton.tsx`
- `components/AddToListButtonMobile.tsx`
- `components/RequestPaperButton.tsx`
- `app/user/layout.tsx`

---

## Technical Notes

### 1. Middleware Session Refresh (Critical)

Supabase SSR **requires** middleware to refresh sessions. The middleware must:
1. Run on ALL routes (update `config.matcher`)
2. Call `getUser()` to validate and refresh tokens
3. Return the response with updated cookies

**Important**: The existing Basic Auth protection for admin routes is preserved. The middleware now does two things in sequence:
1. First: Supabase session refresh (runs on ALL routes)
2. Then: Basic Auth check (only for `/management` and `/api/admin/*` routes)

```typescript
// middleware.ts - updated pattern
export async function middleware(request: NextRequest) {
  // 1. SUPABASE SESSION REFRESH (runs on ALL routes)
  let response = NextResponse.next({ request });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value));
          response = NextResponse.next({ request });
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // CRITICAL: This refreshes the session
  await supabase.auth.getUser();

  // 2. BASIC AUTH FOR ADMIN ROUTES (unchanged from before)
  const isAdminRoute = request.nextUrl.pathname.startsWith('/management') ||
                       request.nextUrl.pathname.startsWith('/api/admin');

  if (isAdminRoute) {
    // Existing Basic Auth logic stays here - unchanged
    // Returns 401 with WWW-Authenticate header if not authorized
  }

  return response;
}

// CHANGED: Matcher now runs on all routes (was only admin routes)
// This allows Supabase to refresh sessions on any page
export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
};
```

### 2. User ID Format Change

- **BetterAuth**: Generated string IDs (variable format)
- **Supabase**: UUID format (e.g., `550e8400-e29b-41d4-a716-446655440000`)

The PostgreSQL `users` table has `id VARCHAR(128)` which accommodates both formats. No schema migration needed.

### 3. User Sync Strategy

Two options for syncing users to the application `users` table:

**Option A: Database Trigger (Recommended)**
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (id, email, created_at)
  VALUES (NEW.id, NEW.email, NOW())
  ON CONFLICT (id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

**Option B: Sync on First API Call**
Check if user exists in `users` table on first authenticated request; create if missing.

### 4. Magic Link Email Template

Configure in Supabase Dashboard → Authentication → Email Templates → Magic Link:

```html
<h2>Sign in to Open Paper Digest</h2>
<p>Click the link below to sign in:</p>
<p><a href="{{ .SiteURL }}/api/auth/confirm?token_hash={{ .TokenHash }}&type=email">Sign In</a></p>
<p>This link expires in 1 hour.</p>
```

### 5. Session Expiry Configuration

**Configured in Supabase Dashboard (not in code):**

BetterAuth was configured for 30-day sessions (`sessionMaxAge: 60 * 60 * 24 * 30`). Supabase handles this differently:

- **Access tokens**: Short-lived (default 1 hour). Configure at Dashboard → Authentication → Settings → JWT Expiry
- **Refresh tokens**: Long-lived, keep users logged in. The middleware's `getUser()` call automatically exchanges expired access tokens for new ones.

To achieve similar 30-day session behavior:
1. Go to Supabase Dashboard → Authentication → Settings
2. Adjust "JWT Expiry" as needed (access token lifetime)
3. Refresh tokens handle the longer session duration automatically

No code changes needed - this is purely dashboard configuration.

### 6. Post-Login Action Updates

The callback page currently sends `X-Auth-Provider-Id` header. After migration, remove this header - Supabase session cookies automatically authenticate the request.

```typescript
// Before
headers.set('X-Auth-Provider-Id', session.user.id);

// After - remove this line, cookies handle auth
```

### 7. Existing Users

Existing users in BetterAuth MySQL database will NOT be migrated automatically. Options:
1. Users re-register (simplest)
2. Write migration script to import users to Supabase `auth.users`

---

## Implementation Phases

### Phase 1: Setup & Dependencies
- [ ] Add `@supabase/supabase-js` and `@supabase/ssr` to `package.json`
- [ ] Remove `better-auth`, `@better-auth/cli`, `mysql2` from `package.json`
- [ ] Add `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` to `.env`
- [ ] Remove `AUTH_MYSQL_URL` and `BETTER_AUTH_SECRET` from `.env`
- [ ] Create/configure Supabase project with Email auth enabled
- [ ] Configure Site URL and Redirect URLs in Supabase Dashboard
- [ ] Customize magic link email template in Supabase Dashboard

### Phase 2: Core Auth Infrastructure & Middleware
- [ ] Create `lib/supabase/client.ts` - browser client factory
- [ ] Create `lib/supabase/server.ts` - server client factory
- [ ] Create `lib/supabase/middleware.ts` - middleware client factory
- [ ] **Update `middleware.ts`** - add Supabase session refresh, update matcher to run on all routes
- [ ] Rewrite `services/auth.ts` with Supabase client and `useSession` hook

### Phase 3: Auth Routes & Callbacks
- [ ] Create `app/api/auth/confirm/route.ts` for magic link verification
- [ ] Delete `app/api/auth/[...betterauth]/route.tsx`
- [ ] Update `app/auth/callback/page.tsx` - use Supabase session, remove `X-Auth-Provider-Id` header
- [ ] Update `app/login/page.tsx` - use `signInWithOtp`

### Phase 4: Protected API Routes Migration
- [ ] Update `app/api/users/me/list/route.ts`
- [ ] Update `app/api/users/me/list/[uuid]/route.ts`
- [ ] Update `app/api/users/me/requests/route.ts`
- [ ] Update `app/api/users/me/requests/[arxivId]/route.ts`
- [ ] Update `app/api/users/me/papers/[uuid]/processing_metrics/route.ts`
- [ ] Delete `app/api/users/sync/route.ts`

### Phase 5: Client Components & Services Migration
- [ ] Update `services/users.ts` - remove `authProviderId` param and `buildAuthHeaders()`
- [ ] Update `services/requests.ts` - remove `authProviderId` param and `buildAuthHeaders()`
- [ ] Update `components/RequireAuth.tsx`
- [ ] Update `components/NavBar.tsx`
- [ ] Update `components/UserSidebar.tsx`
- [ ] Update `components/AddToListButton.tsx` - also remove `sendAddToListMagicLink` usage
- [ ] Update `components/AddToListButtonMobile.tsx` - also remove `sendAddToListMagicLink` usage
- [ ] Update `components/RequestPaperButton.tsx` - also remove `sendRequestPaperMagicLink` usage
- [ ] Update `app/user/layout.tsx`
- [ ] Update `app/user/list/page.tsx`
- [ ] Update `app/user/requests/page.tsx`

### Phase 6: User Sync & Database
- [ ] Create database trigger for user sync (Option A) OR implement sync-on-first-call (Option B)
- [ ] Update `services/users.service.ts` if needed
- [ ] Test user creation flow end-to-end

### Phase 7: Cleanup
- [ ] Delete `lib/server_auth.ts`
- [ ] Delete `lib/auth.ts`
- [ ] Delete `lib/magicLink.ts`
- [ ] Delete `lib/emails/` directory (3 files)
- [ ] Remove any remaining `mysql2` imports or connection code
- [ ] Remove `resend` dependency (only used in deleted `lib/server_auth.ts`)
- [ ] Remove `@react-email/components` and `@react-email/render` dependencies

### Phase 8: Testing & Validation
- [ ] Test magic link sign-in flow (new user)
- [ ] Test magic link sign-in flow (existing user)
- [ ] Test session persistence across page refreshes
- [ ] Test session refresh after expiry (middleware)
- [ ] Test all protected API endpoints return 401 when unauthenticated
- [ ] Test all protected API endpoints work when authenticated
- [ ] Test post-login action queue (add to list flow)
- [ ] Test sign-out flow
- [ ] Test RequireAuth component redirect
- [ ] Verify admin routes still protected with Basic Auth

---

## Success Criteria

1. **Authentication Flow**: Users can sign in via magic link email and receive a valid session
2. **Session Persistence**: Sessions persist across page refreshes and are automatically refreshed when expired
3. **Protected Routes**: All `/api/users/me/*` endpoints correctly authenticate users and return 401 for unauthenticated requests
4. **User Sync**: New users are automatically created in the `users` table upon first authentication
5. **Sign Out**: Users can sign out and their session is properly invalidated
6. **No MySQL Dependency**: The application no longer requires `AUTH_MYSQL_URL` or MySQL connection
7. **Post-Login Actions**: The cookie-based post-login action queue continues to work correctly
8. **Admin Routes**: Basic Auth protection for `/management` and `/api/admin/*` remains functional
9. **All Components Working**: NavBar, UserSidebar, AddToListButton, RequestPaperButton all correctly show auth state
