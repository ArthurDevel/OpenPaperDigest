// Prisma schema for Paper Summarizer
//
// This schema is used for TypeScript database access via Prisma.
// The database schema is managed by Alembic (Python migrations).
// Use `prisma db pull` to sync with database changes, NEVER use `prisma migrate`.
//
// Responsibilities:
// - Define Paper, PaperSlug, PaperStatusHistory models
// - Define User, UserList, UserRequest models
// - Map TypeScript types to existing MySQL schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PAPER MODELS
// ============================================================================

model Paper {
  id                      BigInt    @id @default(autoincrement())
  paperUuid               String    @unique @map("paper_uuid") @db.VarChar(36)
  arxivId                 String?   @unique @map("arxiv_id") @db.VarChar(64)
  arxivVersion            String?   @map("arxiv_version") @db.VarChar(10)
  arxivUrl                String?   @map("arxiv_url") @db.VarChar(255)
  title                   String?   @db.VarChar(512)
  authors                 String?   @db.Text
  status                  String    @default("not_started") @db.VarChar(20)
  errorMessage            String?   @map("error_message") @db.Text
  initiatedByUserId       String?   @map("initiated_by_user_id") @db.VarChar(128)
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  startedAt               DateTime? @map("started_at")
  finishedAt              DateTime? @map("finished_at")
  numPages                Int?      @map("num_pages")
  processingTimeSeconds   Float?    @map("processing_time_seconds")
  totalCost               Float?    @map("total_cost")
  avgCostPerPage          Float?    @map("avg_cost_per_page")
  thumbnailDataUrl        String?   @map("thumbnail_data_url") @db.MediumText
  externalPopularitySignals Json?   @map("external_popularity_signals")
  processedContent        String?   @map("processed_content") @db.LongText
  contentHash             String?   @unique @map("content_hash") @db.VarChar(64)
  pdfUrl                  String?   @map("pdf_url") @db.VarChar(512)

  slugs                   PaperSlug[]
  userLists               UserList[]

  @@map("papers")
  @@index([initiatedByUserId])
  @@index([contentHash])
}

model PaperSlug {
  id        BigInt    @id @default(autoincrement())
  slug      String    @unique @db.VarChar(255)
  paperUuid String?   @map("paper_uuid") @db.VarChar(36)
  createdAt DateTime  @default(now()) @map("created_at")
  tombstone Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  paper     Paper?    @relation(fields: [paperUuid], references: [paperUuid])

  @@map("paper_slugs")
}

model PaperStatusHistory {
  id              BigInt   @id @default(autoincrement())
  date            DateTime @unique @db.Date
  totalCount      Int      @map("total_count")
  failedCount     Int      @map("failed_count")
  processedCount  Int      @map("processed_count")
  notStartedCount Int      @map("not_started_count")
  processingCount Int      @map("processing_count")
  snapshotAt      DateTime @default(now()) @map("snapshot_at")

  @@map("paper_status_history")
  @@index([date])
}

// ============================================================================
// USER MODELS
// ============================================================================

model User {
  id        String     @id @db.VarChar(128)
  email     String     @db.VarChar(255)
  createdAt DateTime   @default(now()) @map("created_at")

  lists     UserList[]
  requests  UserRequest[]

  @@map("users")
}

model UserList {
  id        BigInt   @id @default(autoincrement())
  userId    String   @map("user_id") @db.VarChar(128)
  paperId   BigInt   @map("paper_id")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  paper     Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)

  @@unique([userId, paperId])
  @@map("user_lists")
  @@index([userId])
  @@index([paperId])
}

model UserRequest {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id") @db.VarChar(128)
  arxivId       String   @map("arxiv_id") @db.VarChar(64)
  title         String?  @db.VarChar(512)
  authors       String?  @db.VarChar(2048)
  createdAt     DateTime @default(now()) @map("created_at")
  isProcessed   Boolean  @default(false) @map("is_processed")
  processedSlug String?  @map("processed_slug") @db.VarChar(255)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, arxivId])
  @@map("user_requests")
  @@index([userId])
  @@index([arxivId])
  @@index([isProcessed])
}
