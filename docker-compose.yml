version: '3.8'

#--------------------------------------------------------------------------
# Application Services
#
# Architecture:
# - web: Next.js frontend and API routes (TypeScript)
# - worker: Airflow-based background processing (Python)
# - umami: Privacy-focused analytics
#
# Database: PostgreSQL hosted on Supabase (external)
#--------------------------------------------------------------------------
services:

  #--------------------------------------------------------------------------
  # Web Service (Next.js)
  #--------------------------------------------------------------------------
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    env_file:
      - ./worker/.env
    environment:
      - NODE_ENV=production
    ports:
      - "3000:3000"
    volumes:
      - ./data/paperjsons:/app/data/paperjsons
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  #--------------------------------------------------------------------------
  # Worker Service (Airflow)
  #--------------------------------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    env_file:
      - ./worker/.env
    ports:
      - "8080:8080"
    volumes:
      - ./worker/dags:/opt/airflow/dags
      - ./worker/logs:/opt/airflow/logs
      - ./data/paperjsons:/app/data/paperjsons
    depends_on:
      airflow-postgres:
        condition: service_healthy
    restart: unless-stopped

  #--------------------------------------------------------------------------
  # Analytics Service (Umami)
  # Access at http://localhost:3001 | Default login: admin / umami
  #--------------------------------------------------------------------------
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    container_name: papersummarizer-umami
    restart: always
    ports:
      - "3001:3000"
    environment:
      DATABASE_URL: postgresql://umami:umami@umami-postgres:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: change-me-in-production
    depends_on:
      umami-postgres:
        condition: service_healthy

  umami-postgres:
    image: postgres:15-alpine
    container_name: papersummarizer-umami-postgres
    restart: always
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
    volumes:
      - ./data/umami-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U umami"]
      interval: 5s
      timeout: 5s
      retries: 5

  #--------------------------------------------------------------------------
  # Airflow Postgres Database
  #--------------------------------------------------------------------------
  airflow-postgres:
    image: postgres:13
    container_name: papersummarizer-airflow-postgres
    restart: always
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - ./data/airflow-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  airflow-postgres:
